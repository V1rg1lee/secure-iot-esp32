<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
        <title>KMS Logs</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<header class="site-header">
    <div class="container">
        <h1>KMS — Logs</h1>
        <p class="lead">Encrypted MQTT event stream for ESP32 nodes.</p>
    </div>
</header>

<main class="container main">
    <div class="controls">
        <div class="meta">Last updated: <span id="last">—</span></div>
        <button id="btn-refresh" class="btn small">Refresh</button>
    </div>

    <section id="logs" class="logs" aria-live="polite">Loading…</section>
</main>

<script>
function formatTime(ts) {
    try {
        const d = new Date(ts);
        return d.toLocaleString();
    } catch {
        return ts;
    }
}

async function loadLogs() {
    const logDiv = document.getElementById("logs");
    const lastSpan = document.getElementById("last");
    try {
        const res = await fetch("http://localhost:8000/events");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        logDiv.innerHTML = "";  // reset

        const lines = text.split("\n").filter(l => l.trim().length > 0);
        if (lines.length === 0) {
            logDiv.innerHTML = '<div class="empty">Any recent event.</div>';
            lastSpan.textContent = new Date().toLocaleTimeString();
            return;
        }

        for (const line of lines) {
            try {
                const obj = JSON.parse(line);

                const item = document.createElement('article');
                item.className = 'log-item';

                const metaCol = document.createElement('div');
                metaCol.className = 'meta-col';
                const timeBadge = document.createElement('div');
                timeBadge.className = 'badge';
                timeBadge.textContent = formatTime(obj.timestamp);
                metaCol.appendChild(timeBadge);

                const content = document.createElement('div');
                content.className = 'content';
                const title = document.createElement('div');
                title.className = 'title';
                title.textContent = obj.client_id || 'unknown client';
                const topic = document.createElement('div');
                topic.className = 'topic';
                topic.textContent = obj.topic_name + (obj.epoch !== undefined ? ` — epoch ${obj.epoch}` : '');

                const payload = document.createElement('pre');
                payload.className = 'payload';
                // Format payload: prefer human-friendly display for known keys
                let dataText = '';
                // If data is a JSON string, try to parse it
                if (typeof obj.data === 'string') {
                    try {
                        obj.data = JSON.parse(obj.data);
                    } catch (e) {
                        // leave as string
                    }
                }

                if (obj.data && typeof obj.data === 'object') {
                    // Pretty format known sensor payloads and keep labels
                    const parts = [];
                    if (obj.data.temperature !== undefined) {
                        parts.push(`Temperature: ${obj.data.temperature} °C`);
                    }
                    if (obj.data.humidity !== undefined) {
                        parts.push(`Humidity: ${obj.data.humidity} %`);
                    }
                    if (parts.length > 0) {
                        dataText = parts.join('\n');
                    } else {
                        try {
                            dataText = JSON.stringify(obj.data, null, 2);
                        } catch (e) {
                            dataText = String(obj.data);
                        }
                    }
                } else {
                    dataText = String(obj.data ?? '');
                }

                if (dataText.length > 600) dataText = dataText.slice(0,600) + '…';
                payload.textContent = dataText;

                content.appendChild(title);
                content.appendChild(topic);
                content.appendChild(payload);

                item.appendChild(metaCol);
                item.appendChild(content);

                logDiv.appendChild(item);

            } catch (e) {
                console.warn("Ignored invalid JSON line:", e, line);
            }
        }

        lastSpan.textContent = new Date().toLocaleTimeString();

    } catch (err) {
        console.error("Fetch error:", err);
        logDiv.innerHTML = '<div class="empty">Loading error.</div>';
        lastSpan.textContent = '—';
    }
}

document.getElementById('btn-refresh').addEventListener('click', loadLogs);
// reload every second
setInterval(loadLogs, 1000);
loadLogs();
</script>

</body>
</html>
